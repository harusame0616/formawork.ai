# Next.js キャッシュ戦略ガイドライン

## cache directive

適切な use cache ディレクティブを利用すること。

Next.js は、それぞれ異なるユースケース向けに設計された 3 つのキャッシュディレクティブを提供する。

| 特徴 | `use cache` | `use cache: remote` | `use cache: private` |
|------|-------------|---------------------|----------------------|
| **動的なコンテキストで動作する** | いいえ（静的コンテキストが必要） | はい（動的なコンテキスト向けに設計） | はい |
| **`await cookies()` にアクセス** | いいえ | いいえ | はい |
| **`await headers()` にアクセス** | いいえ | いいえ | はい |
| **`await connection()` の後** | いいえ（キャッシュしません） | いいえ | いいえ |
| **キャッシュハンドラーに保存** | はい（サーバー側） | はい（サーバー側） | いいえ（クライアント側のみ） |
| **キャッシュスコープ** | グローバル（共有） | グローバル（共有） | ユーザーごと（分離） |
| **ランタイムプリフェッチをサポート** | N/A (ビルド時に事前レンダリング) | いいえ | はい（設定されている場合） |
| **使用事例** | 静的共有コンテンツ（ビルド時） | ランタイムコンテキストでの動的な共有コンテンツ（リクエストごと） | パーソナライズされたユーザー固有のコンテンツ |

### "use cache" のユースケース

- コンテンツがビルド時に事前レンダリングできる場合
- コンテンツがすべてのユーザー間で共有される場合
- コンテンツがリクエスト固有のデータに依存しない場合

### "use cache: remote" のユースケース

- 動的コンテキスト内でのキャッシュが必要な場合
- コンテンツがユーザー間で共有されるが、リクエストごとにレンダリングする必要がある場合（`await connection()` のあと）
- 高価な操作をサーバー側のキャッシュハンドラーにキャッシュしたい場合

### "use cache: private" のユースケース

- コンテンツがユーザーごとにパーソナライズされる場合（Cookie、ヘッダーによって異なる）
- ユーザー固有のコンテンツの実行時プリフェッチが必要な場合
- コンテンツをユーザー間で共有してはならない場合

## cacheLife

### データの更新をアプリで制御できる場合

アプリ内の DB のデータや webhook で検知できる外部データが対象。

- カスタムプロファイル permanent を利用し、キャッシュの更新が必要なタイミングで `revalidateTag()` を行うこと
- `cacheTag()` を使って更新タイミングに応じたタグを設定すること
  - 例: `cacheTag("parent-delete", "foo-update")`

### データの更新タイミングをアプリで制御できない場合

外部 API やデータの更新を制御できても一定間隔での更新で十分な場合が対象。

- `"hours"`、`"days"`、カスタム時間など要件に応じた時間を指定すること
